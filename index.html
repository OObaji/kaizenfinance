<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaizen Finance | Continuous Improvement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Standard Global Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0F172A;
            color: #F1F5F9;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        [v-cloak] { display: none; }

        .animate-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #deployment-error {
            display: none;
            position: fixed;
            inset: 0;
            background: #0f172a;
            color: #ef4444;
            padding: 2rem;
            z-index: 9999;
            font-family: monospace;
            text-align: center;
            justify-content: center;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="deployment-error">
        <h1 style="font-size: 1.5rem; margin-bottom: 1rem;">Network Error</h1>
        <p id="error-message" class="text-slate-400 mb-4"></p>
        <button onclick="location.reload()" class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold">Retry</button>
    </div>

    <div id="app" v-cloak>
        <!-- Landing Page -->
        <div v-if="authState === 'landing'" class="min-h-screen flex flex-col items-center justify-center p-6 text-center animate-in">
            <div class="mb-8">
                <div class="relative w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white shadow-2xl rotate-3 mx-auto">
                    <i data-lucide="arrow-up-right" class="w-12 h-12"></i>
                </div>
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter mb-6 bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">Kaizen Finance</h1>
            <p class="text-xl md:text-2xl text-slate-400 max-w-2xl mb-12 font-medium leading-relaxed">Continuous improvement for your financial future. Aggressively track and destroy your debts.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl w-full mb-16 text-left">
                <div v-for="feature in features" :key="feature.title" class="glass p-6 rounded-[2rem]">
                    <div :class="feature.color" class="p-3 w-fit rounded-xl mb-4 text-white">
                        <i :data-lucide="feature.icon"></i>
                    </div>
                    <h3 class="font-bold mb-2 text-white">{{ feature.title }}</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">{{ feature.desc }}</p>
                </div>
            </div>

            <div class="flex gap-4">
                <button @click="authState = 'login'" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-5 rounded-[2rem] font-black text-xl flex items-center gap-3 transition-all hover:scale-105 active:scale-95">
                    Login <i data-lucide="arrow-right"></i>
                </button>
                <button @click="authState = 'register'" class="bg-slate-800 hover:bg-slate-700 text-white px-10 py-5 rounded-[2rem] font-black text-xl flex items-center gap-3 transition-all hover:scale-105 active:scale-95">
                    Sign Up
                </button>
            </div>
        </div>

        <!-- Auth Pages -->
        <div v-if="authState === 'login' || authState === 'register'" class="min-h-screen flex items-center justify-center p-6 animate-in text-left">
            <div class="w-full max-w-md glass p-10 rounded-[2.5rem] shadow-2xl">
                <div class="flex flex-col items-center mb-10 text-center">
                    <h2 class="text-3xl font-black text-white tracking-tighter">{{ authState === 'login' ? 'Welcome Back' : 'Join Kaizen' }}</h2>
                    <p class="text-slate-500 text-sm mt-1">One percent better every day.</p>
                </div>

                <form @submit.prevent="handleAuth" class="space-y-4">
                    <div v-if="authState === 'register'">
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-1">Full Name</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-4 h-4"></i>
                            <input v-model="authData.name" type="text" required class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-3.5 pl-12 pr-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-1">Email</label>
                        <div class="relative">
                            <i data-lucide="mail" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-4 h-4"></i>
                            <input v-model="authData.email" type="email" required class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-3.5 pl-12 pr-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-1">Password</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-4 h-4"></i>
                            <input v-model="authData.password" :type="showPassword ? 'text' : 'password'" required class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-3.5 pl-12 pr-12 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            <button type="button" @click="showPassword = !showPassword" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white">
                                <i :data-lucide="showPassword ? 'eye-off' : 'eye'" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" :disabled="isLoadingAuth" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4.5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all mt-4 disabled:opacity-50">
                        <span v-if="isLoadingAuth" class="flex items-center justify-center gap-2 animate-pulse">Processing...</span>
                        <span v-else>{{ authState === 'login' ? 'Sign In' : 'Create Account' }}</span>
                    </button>
                </form>
                
                <p class="text-center mt-8 text-slate-500 text-sm">
                    {{ authState === 'login' ? "New here?" : "Joined already?" }}
                    <button @click="authState = authState === 'login' ? 'register' : 'login'" class="text-indigo-400 font-bold hover:underline">
                        {{ authState === 'login' ? 'Create Account' : 'Login' }}
                    </button>
                </p>
            </div>
        </div>

        <!-- Dashboard Layout -->
        <div v-if="authState === 'dashboard'" class="min-h-screen flex flex-col lg:flex-row text-left">
            <!-- Sidebar -->
            <aside class="w-full lg:w-80 bg-slate-900 border-r border-slate-800 flex flex-col h-screen overflow-y-auto custom-scrollbar shrink-0">
                <div class="p-8 flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white"><i data-lucide="arrow-up-right"></i></div>
                    <div class="text-left">
                        <span class="text-xl font-black tracking-tighter block leading-tight text-white">Kaizen</span>
                        <span class="text-[10px] text-indigo-400 font-black uppercase tracking-widest block">Continuous Growth</span>
                    </div>
                </div>

                <nav class="flex-1 px-6 space-y-1 mt-4">
                    <p class="px-4 text-[10px] font-black text-slate-600 uppercase tracking-widest mb-4">Main Navigation</p>
                    <button v-for="item in navItems" :key="item.id" @click="currentPage = item.id" :class="currentPage === item.id ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-semibold transition-all">
                        <i :data-lucide="item.icon" class="w-5 h-5"></i>
                        <span>{{ item.label }}</span>
                    </button>
                    <div class="h-px bg-slate-800 my-4 mx-4"></div>
                    <p class="px-4 text-[10px] font-black text-slate-600 uppercase tracking-widest mb-4">Debt Categories</p>
                    <button v-for="cat in categories" :key="cat.id" @click="currentPage = cat.id" :class="currentPage === cat.id ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl font-semibold transition-all">
                        <i :data-lucide="cat.icon" class="w-5 h-5"></i>
                        <span>{{ cat.label }}</span>
                    </button>
                </nav>

                <div class="p-6 mt-auto border-t border-slate-800 bg-slate-900/50">
                    <div class="flex items-center gap-4 p-4 glass rounded-2xl">
                        <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center font-black text-white capitalize shadow-lg">{{ userName?.[0] }}</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-black text-white truncate">{{ userName }}</p>
                            <p class="text-[10px] text-emerald-500 font-bold uppercase">Destroyer</p>
                        </div>
                        <button @click="handleLogout" class="text-slate-500 hover:text-rose-400"><i data-lucide="log-out"></i></button>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 h-screen overflow-y-auto custom-scrollbar p-6 md:p-12 lg:p-16 max-w-[1400px] w-full mx-auto">
                
                <!-- Overview View -->
                <div v-if="currentPage === 'dashboard'" class="space-y-8">
                    <!-- Progress Card -->
                    <div class="glass p-8 md:p-12 rounded-[2.5rem] relative overflow-hidden shadow-2xl">
                        <div class="flex justify-between items-center mb-10">
                            <div class="text-left text-white">
                                <h2 class="text-2xl font-black flex items-center gap-3"><i data-lucide="trophy" class="text-amber-500"></i> Journey to Freedom</h2>
                                <p class="text-slate-400 text-sm mt-1">Consistency compounds.</p>
                            </div>
                            <span class="text-5xl font-black text-indigo-500">{{ progressPercent }}%</span>
                        </div>
                        <div class="h-4 w-full bg-slate-900 rounded-full overflow-hidden p-1 border border-slate-800">
                            <div class="h-full bg-gradient-to-r from-indigo-600 to-emerald-500 rounded-full transition-all duration-1000 shadow-[0_0_20px_#6366f1]" :style="{ width: progressPercent + '%' }"></div>
                        </div>
                        <div class="flex justify-between mt-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">
                            <span>Start</span>
                            <span :class="progressPercent >= 70 ? 'text-emerald-400' : ''">Home Stretch (70%)</span>
                            <span>Freedom</span>
                        </div>
                    </div>

                    <!-- Terminology Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="glass p-8 rounded-[2rem] text-left">
                            <div class="bg-rose-500/20 text-rose-500 p-3 rounded-2xl w-fit mb-4"><i data-lucide="trending-down"></i></div>
                            <h3 class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Total debt</h3>
                            <p class="text-3xl font-black text-white mt-1">£{{ totalBalance.toLocaleString() }}</p>
                        </div>
                        <div class="glass p-8 rounded-[2rem] text-left">
                            <div class="bg-amber-500/20 text-amber-500 p-3 rounded-2xl w-fit mb-4"><i data-lucide="calendar"></i></div>
                            <h3 class="text-slate-500 text-[10px] font-black uppercase tracking-widest">Minimum payments</h3>
                            <p class="text-3xl font-black text-white mt-1">£{{ totalMinPayment.toLocaleString() }}</p>
                        </div>
                        <div class="glass p-8 rounded-[2rem] text-left">
                            <div class="bg-indigo-500/20 text-indigo-500 p-3 rounded-2xl w-fit mb-4"><i data-lucide="zap"></i></div>
                            <h3 class="text-slate-500 text-[10px] font-black uppercase tracking-widest">total payments</h3>
                            <p class="text-3xl font-black text-white mt-1">£{{ (totalMinPayment + extraPayment).toLocaleString() }}</p>
                        </div>
                    </div>

                    <!-- Category List -->
                    <div class="glass p-10 rounded-[2.5rem]">
                        <h2 class="text-2xl font-black text-white mb-8">Repayment Streams</h2>
                        <div class="space-y-4">
                            <div v-for="cat in categorySummaries" :key="cat.name" @click="currentPage = cat.id" class="flex items-center justify-between p-6 rounded-2xl hover:bg-slate-800 transition-all cursor-pointer group">
                                <div class="flex items-center gap-4">
                                    <div :class="cat.color" class="p-3 rounded-xl text-white shadow-lg"><i :data-lucide="cat.icon"></i></div>
                                    <div class="text-left">
                                        <p class="font-black text-white text-lg">{{ cat.name }}s</p>
                                        <p class="text-xs text-slate-500 uppercase tracking-widest">£{{ cat.paid.toLocaleString() }} Repaid</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xl font-black text-white">£{{ cat.balance.toLocaleString() }}</p>
                                    <div class="flex items-center gap-2 mt-1 justify-end">
                                        <div class="w-16 h-1.5 bg-slate-900 rounded-full overflow-hidden">
                                            <div :class="cat.color" class="h-full" :style="{ width: cat.pct + '%' }"></div>
                                        </div>
                                        <span class="text-[10px] font-black text-indigo-400">{{ Math.round(cat.pct) }}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Academy View -->
                <div v-if="currentPage === 'info'" class="animate-in space-y-12 max-w-4xl mx-auto">
                    <h2 class="text-5xl font-black text-white tracking-tighter">Academy</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                        <div class="glass p-10 rounded-[3rem] border-l-4 border-indigo-500">
                            <h3 class="text-2xl font-black text-white mb-4">Compound Aggression</h3>
                            <p class="text-slate-400 leading-relaxed">Debt grows with interest. Freedom grows with consistency. Every £1 you pay above the minimum is a punch to the face of your debt.</p>
                        </div>
                        <div class="glass p-10 rounded-[3rem] border-l-4 border-emerald-500">
                            <h3 class="text-2xl font-black text-white mb-4">Small Wins Matter</h3>
                            <p class="text-slate-400 leading-relaxed">Don't look at the mountain. Look at the next step. Clearing your smallest category gives your brain the dopamine needed for the big battles.</p>
                        </div>
                    </div>
                </div>

                <!-- Category Manager View -->
                <div v-if="isCategoryPage" class="animate-in space-y-10">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-12">
                        <div class="flex items-center gap-6">
                            <div :class="activeCategoryMeta.color" class="p-5 rounded-2xl text-white shadow-2xl rotate-2"><i :data-lucide="activeCategoryMeta.icon" class="w-10 h-10"></i></div>
                            <div class="text-left">
                                <h2 class="text-4xl font-black text-white tracking-tighter">{{ activeCategoryMeta.name }}</h2>
                                <p class="text-slate-500 font-medium">Outstanding: <span class="text-white font-black">£{{ activeCategoryTotal.toLocaleString() }}</span></p>
                            </div>
                        </div>
                        <button @click="addNewEntry" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-4 rounded-2xl font-black shadow-xl transition-all active:scale-95">Add Entry</button>
                    </div>

                    <div class="space-y-4">
                        <div v-if="filteredDebts.length === 0" class="glass border-2 border-dashed border-slate-700/50 py-24 rounded-[3rem] flex flex-col items-center gap-4 opacity-50">
                            <i data-lucide="target" class="w-12 h-12"></i>
                            <p class="font-black uppercase tracking-widest text-xs">Section Clear</p>
                        </div>
                        <div v-for="debt in filteredDebts" :key="debt.id" class="glass p-8 rounded-[2.5rem] flex flex-col md:flex-row items-center gap-10 border-l-[6px]" :style="{ borderLeftColor: activeCategoryMeta.hex }">
                            <div class="flex-1 w-full text-left">
                                <div class="flex items-center gap-4 mb-6">
                                    <input v-model="debt.name" @change="updateDebt(debt.id, 'name', debt.name)" class="text-2xl font-black bg-transparent border-b-2 border-transparent focus:border-indigo-500 transition-all outline-none text-white w-full" placeholder="Label...">
                                    <button @click="openHistory(debt)" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-indigo-400 font-bold text-xs uppercase tracking-widest flex items-center gap-2"><i data-lucide="history" class="w-4 h-4"></i> <span>Log</span></button>
                                </div>
                                <div class="flex flex-wrap gap-4">
                                    <div class="bg-slate-900/50 px-4 py-2 rounded-xl flex items-center gap-2 border border-slate-800">
                                        <span class="text-[10px] font-black text-slate-500 uppercase">APR:</span>
                                        <input type="number" v-model.number="debt.interest" @change="updateDebt(debt.id, 'interest', debt.interest)" class="w-12 bg-transparent text-white font-bold outline-none text-sm">%
                                    </div>
                                    <div class="bg-slate-900/50 px-4 py-2 rounded-xl flex items-center gap-2 border border-slate-800">
                                        <span class="text-[10px] font-black text-slate-500 uppercase">Min: £</span>
                                        <input type="number" v-model.number="debt.min_payment" @change="updateDebt(debt.id, 'min_payment', debt.min_payment)" class="w-16 bg-transparent text-white font-bold outline-none text-sm">
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-8 w-full md:w-auto">
                                <div class="text-right">
                                    <p class="text-[10px] font-black text-slate-600 uppercase tracking-widest mb-1">Value Owed</p>
                                    <div class="flex items-center bg-slate-900 px-6 py-4 rounded-3xl border border-white/5">
                                        <span class="text-2xl font-black text-slate-500 leading-none">£</span>
                                        <input type="number" v-model.number="debt.balance" @change="updateDebt(debt.id, 'balance', debt.balance)" class="text-3xl font-black text-white bg-transparent w-32 text-right outline-none">
                                    </div>
                                </div>
                                <button @click="deleteDebt(debt.id)" class="p-5 hover:bg-rose-500/10 text-slate-600 hover:text-rose-500 rounded-2xl transition-all"><i data-lucide="trash-2"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- History / Injection Modal -->
        <div v-if="activeDebt" class="fixed inset-0 z-[100] flex items-center justify-end bg-slate-950/90 backdrop-blur-xl animate-in">
            <div class="w-full max-w-md h-full bg-slate-900 border-l border-white/5 p-10 flex flex-col shadow-2xl">
                <div class="flex justify-between items-center mb-12">
                    <div class="text-left">
                        <h3 class="text-3xl font-black text-white tracking-tighter">Log Injection</h3>
                        <p class="text-slate-500 text-sm font-bold uppercase tracking-widest">{{ activeDebt.name }}</p>
                    </div>
                    <button @click="activeDebt = null" class="p-3 bg-slate-800 rounded-2xl text-slate-400 hover:text-white transition-all"><i data-lucide="x"></i></button>
                </div>
                <form @submit.prevent="submitPayment" class="p-8 glass rounded-[2.5rem] mb-10 text-left">
                    <div class="space-y-6">
                        <div class="bg-slate-950 p-5 rounded-2xl border border-white/5">
                            <span class="text-slate-500 font-black mr-2">£</span>
                            <input v-model.number="payAmount" type="number" step="0.01" required placeholder="0.00" class="w-full bg-transparent text-4xl font-black text-white outline-none">
                        </div>
                        <input v-model="payDate" type="date" required class="w-full bg-slate-950 p-4 rounded-2xl border border-white/5 text-white font-bold [color-scheme:dark]">
                        <button type="submit" class="w-full bg-indigo-600 py-6 rounded-3xl font-black text-lg shadow-2xl shadow-indigo-900/50 hover:bg-indigo-500 transition-all text-white uppercase tracking-widest">Execute</button>
                    </div>
                </form>
                <div class="flex-1 overflow-y-auto custom-scrollbar">
                    <div class="space-y-4">
                        <div v-for="pay in sortedPayments" :key="pay.id" class="flex justify-between p-5 glass rounded-2xl items-center text-left">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                <div>
                                    <p class="text-white font-black">£{{ pay.amount.toLocaleString() }}</p>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase">{{ pay.date }}</p>
                                </div>
                            </div>
                            <span class="text-[10px] font-black text-emerald-500 uppercase bg-emerald-500/10 px-3 py-1 rounded-full">Crushed</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div v-if="notification" class="fixed bottom-10 right-10 z-[110] bg-indigo-600 text-white px-8 py-5 rounded-full shadow-2xl flex items-center gap-4 animate-in border border-white/20">
            <i data-lucide="zap"></i>
            <span class="font-black text-base tracking-tight uppercase italic">{{ notification }}</span>
        </div>
    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted, watch } = Vue;

        const SUPABASE_URL = 'https://clstohryamyzfwfymrrr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNsc3RvaHJ5YW15emZ3dGZ5bXJyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTI0NjgsImV4cCI6MjA4NTY4ODQ2OH0.NIef4prO_6ei9GCl2fUGgL-wEZkCdToiqfa215oic5s';
        
        // Ensure supabase is loaded from CDN global before initializing
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        createApp({
            setup() {
                const authState = ref('landing');
                const user = ref(null);
                const userName = ref('Warrior');
                const isLoading = ref(true);
                const isLoadingAuth = ref(false);
                const currentPage = ref('dashboard');
                const notification = ref(null);
                const debts = ref([]);
                const extraPayment = ref(200);
                const strategy = ref('snowball');
                const showPassword = ref(false);
                
                const authData = ref({ email: '', password: '', name: '' });
                const activeDebt = ref(null);
                const payAmount = ref(null);
                const payDate = ref(new Date().toISOString().split('T')[0]);

                const navItems = [
                    { id: 'dashboard', label: 'Overview', icon: 'layout-dashboard' },
                    { id: 'info', label: 'Academy', icon: 'graduation-cap' },
                ];

                const categories = [
                    { id: 'credit-cards', label: 'Credit Cards', icon: 'credit-card', key: 'Credit Card', color: 'bg-blue-600', hex: '#2563eb' },
                    { id: 'education', label: 'School Fees', icon: 'book-open', key: 'Education', color: 'bg-emerald-600', hex: '#059669' },
                    { id: 'personal', label: 'Personal Debts', icon: 'user', key: 'Personal', color: 'bg-purple-600', hex: '#9333ea' },
                    { id: 'subscriptions', label: 'Subscriptions', icon: 'trash-2', key: 'Subscriptions', color: 'bg-rose-500', hex: '#f43f5e' },
                ];

                const features = [
                    { title: 'Momentum Logic', desc: 'Watch how injections crush your debt velocity.', icon: 'zap', color: 'bg-indigo-600' },
                    { title: '70% Home Stretch', desc: 'The critical turning point in habits.', icon: 'trophy', color: 'bg-emerald-600' },
                    { title: 'Real-time Sync', desc: 'Cloud powered data via Supabase.', icon: 'cloud', color: 'bg-blue-600' }
                ];

                const markers = [{ p: 0, l: 'Launch' }, { p: 70, l: 'Home Stretch', target: true }, { p: 100, l: 'Kaizen' }];

                onMounted(async () => {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session) {
                        user.value = session.user;
                        await loadProfile();
                        authState.value = 'dashboard';
                        fetchDebts();
                    }
                    isLoading.value = false;
                    initIcons();

                    supabaseClient.auth.onAuthStateChange(async (_event, session) => {
                        if (session) {
                            user.value = session.user;
                            await loadProfile();
                            authState.value = 'dashboard';
                            fetchDebts();
                        } else {
                            user.value = null;
                            if (authState.value === 'dashboard') authState.value = 'landing';
                        }
                    });
                });

                const handleAuth = async () => {
                    isLoadingAuth.value = true;
                    try {
                        if (authState.value === 'login') {
                            const { error } = await supabaseClient.auth.signInWithPassword({ email: authData.value.email, password: authData.value.password });
                            if (error) throw error;
                        } else {
                            const { data, error } = await supabaseClient.auth.signUp({ 
                                email: authData.value.email, 
                                password: authData.value.password,
                                options: { data: { name: authData.value.name } }
                            });
                            if (error) throw error;
                            if (data.user) {
                                await supabaseClient.from('profiles').upsert([{ id: data.user.id, name: authData.value.name, email: authData.value.email }]);
                                showToast("Confirm your email or log in!");
                            }
                        }
                    } catch (e) {
                        showToast(e.message);
                    } finally {
                        isLoadingAuth.value = false;
                    }
                };

                const loadProfile = async () => {
                    if (!user.value) return;
                    const { data } = await supabaseClient.from('profiles').select('name').eq('id', user.value.id).single();
                    userName.value = data?.name || user.value.user_metadata?.name || 'Warrior';
                };

                const fetchDebts = async () => {
                    if (!user.value) return;
                    const { data } = await supabaseClient.from('debts').select('*').order('created_at', { ascending: false });
                    if (data) debts.value = data;
                    initIcons();
                };

                const handleLogout = async () => { await supabaseClient.auth.signOut(); authState.value = 'landing'; debts.value = []; };
                const navigateTo = (page) => { currentPage.value = page; initIcons(); };
                const initIcons = () => setTimeout(() => lucide.createIcons(), 150);

                const totalBalance = computed(() => debts.value.reduce((s, d) => s + (parseFloat(d.balance) || 0), 0));
                const totalPaid = computed(() => debts.value.reduce((s, d) => s + (d.payments?.reduce((ps, p) => ps + p.amount, 0) || 0), 0));
                const totalMinPayment = computed(() => debts.value.reduce((s, d) => s + (parseFloat(d.min_payment) || 0), 0));
                const progressPercent = computed(() => {
                    const original = totalBalance.value + totalPaid.value;
                    return original > 0 ? Math.round((totalPaid.value / original) * 100) : 0;
                });

                const mainStats = computed(() => [
                    { title: 'Total debt', value: totalBalance.value, icon: 'trending-down', color: 'bg-rose-500/80', sub: 'Outstanding amount' },
                    { title: 'Minimum payments', value: totalMinPayment.value, icon: 'calendar', color: 'bg-amber-500/80', sub: 'Mandatory burn' },
                    { title: 'total payments', value: totalMinPayment.value + extraPayment.value, icon: 'zap', color: 'bg-indigo-500/80', sub: 'Velocity score' }
                ]);

                const categorySummaries = computed(() => {
                    return categories.map(c => {
                        const items = debts.value.filter(d => d.category === c.key);
                        const bal = items.reduce((s, d) => s + (parseFloat(d.balance) || 0), 0);
                        const paid = items.reduce((s, d) => s + (d.payments?.reduce((ps, p) => ps + p.amount, 0) || 0), 0);
                        return { id: c.id, name: c.key, balance: bal, paid, pct: (bal + paid) > 0 ? (paid / (bal + paid)) * 100 : 0, color: c.color, icon: c.icon };
                    });
                });

                const isCategoryPage = computed(() => categories.some(c => c.id === currentPage.value));
                const activeCategoryMeta = computed(() => categories.find(c => c.id === currentPage.value) || {});
                const activeCategoryKey = computed(() => activeCategoryMeta.value.key);
                const activeCategoryTotal = computed(() => debts.value.filter(d => d.category === activeCategoryKey.value).reduce((s, d) => s + (parseFloat(d.balance) || 0), 0));
                const filteredDebts = computed(() => debts.value.filter(d => d.category === activeCategoryKey.value));

                const addNewEntry = async () => {
                    if (!user.value) return;
                    await supabaseClient.from('debts').insert([{ name: `New ${activeCategoryKey.value}`, balance: 0, interest: 0, min_payment: 0, category: activeCategoryKey.value, user_id: user.value.id }]);
                    fetchDebts();
                };

                const updateDebt = async (id, field, val) => {
                    if (!user.value) return;
                    await supabaseClient.from('debts').update({ [field]: val }).eq('id', id);
                    fetchDebts();
                };

                const deleteDebt = async (id) => {
                    if (!user.value) return;
                    await supabaseClient.from('debts').delete().eq('id', id);
                    fetchDebts();
                    showToast("Removed Data Point");
                };

                const openHistory = (debt) => { activeDebt.value = debt; payAmount.value = null; };
                const sortedPayments = computed(() => activeDebt.value?.payments ? [...activeDebt.value.payments].sort((a,b) => new Date(b.date) - new Date(a.date)) : []);

                const submitPayment = async () => {
                    if (!activeDebt.value || !payAmount.value) return;
                    const newPayments = [...(activeDebt.value.payments || []), { amount: payAmount.value, date: payDate.value, id: crypto.randomUUID() }];
                    const newBalance = Math.max(0, activeDebt.value.balance - payAmount.value);
                    await supabaseClient.from('debts').update({ balance: newBalance, payments: newPayments }).eq('id', activeDebt.value.id);
                    activeDebt.value = null; fetchDebts();
                    showToast("Injected Success");
                };

                const showToast = (msg) => { notification.value = msg; setTimeout(() => notification.value = null, 4000); };

                return {
                    authState, user, isLoading, isLoadingAuth, currentPage, notification, debts, extraPayment, strategy, showPassword,
                    authData, activeDebt, payAmount, payDate, totalBalance, totalPaid, totalMinPayment, progressPercent,
                    mainStats, categorySummaries, isCategoryPage, activeCategoryMeta, activeCategoryKey, activeCategoryTotal, filteredDebts,
                    handleAuth, handleLogout, navigateTo, addNewEntry, updateDebt, deleteDebt, openHistory, sortedPayments, submitPayment,
                    userName, navItems, categories, features, markers
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
