<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaizen Finance | Continuous Improvement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0F172A;
            color: #F1F5F9;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glass {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        [v-cloak] { display: none; }

        input[type="range"] {
            -webkit-appearance: none;
            background: #1E293B;
            border-radius: 10px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #6366F1;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }

        .animate-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Error overlay for debugging deployment issues */
        #deployment-error {
            display: none;
            position: fixed;
            inset: 0;
            background: #0f172a;
            color: #ef4444;
            padding: 2rem;
            z-index: 9999;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Fallback error UI for unexpected JS crashes -->
    <div id="deployment-error">
        <h1 style="font-size: 1.5rem; margin-bottom: 1rem;">Application Failed to Start</h1>
        <p id="error-message"></p>
    </div>

    <div id="app" v-cloak>
        <!-- Landing Page -->
        <div v-if="authState === 'landing'" class="min-h-screen flex flex-col items-center justify-center p-6 text-center animate-in">
            <div class="mb-8">
                <div class="relative w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center text-white shadow-2xl shadow-indigo-900/40 mx-auto rotate-3">
                    <i data-lucide="arrow-up-right" class="w-12 h-12"></i>
                </div>
            </div>
            <h1 class="text-5xl md:text-7xl font-black tracking-tighter mb-6 bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">Kaizen Finance</h1>
            <p class="text-xl md:text-2xl text-slate-400 max-w-2xl mb-12 font-medium leading-relaxed">Continuous improvement for your financial future. Aggressively track and destroy your debts.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl w-full mb-16 text-left">
                <div v-for="feature in features" :key="feature.title" class="glass p-6 rounded-[2rem]">
                    <div :class="feature.color" class="p-3 w-fit rounded-xl mb-4 text-white">
                        <i :data-lucide="feature.icon"></i>
                    </div>
                    <h3 class="font-bold mb-2 text-white">{{ feature.title }}</h3>
                    <p class="text-sm text-slate-500 leading-relaxed">{{ feature.desc }}</p>
                </div>
            </div>

            <div class="flex gap-4">
                <button @click="authState = 'login'" class="bg-indigo-600 hover:bg-indigo-700 text-white px-10 py-5 rounded-[2rem] font-black text-xl flex items-center gap-3 transition-all hover:scale-105 shadow-2xl active:scale-95">
                    Login <i data-lucide="arrow-right"></i>
                </button>
                <button @click="authState = 'register'" class="bg-slate-800 hover:bg-slate-700 text-white px-10 py-5 rounded-[2rem] font-black text-xl flex items-center gap-3 transition-all hover:scale-105 border border-slate-700 active:scale-95">
                    Sign Up
                </button>
            </div>
        </div>

        <!-- Login Page -->
        <div v-if="authState === 'login'" class="min-h-screen flex items-center justify-center p-6 animate-in">
            <div class="w-full max-w-md glass p-10 rounded-[2.5rem] shadow-2xl">
                <div class="flex flex-col items-center mb-10">
                    <kaizen-logo size="32"></kaizen-logo>
                    <h2 class="text-3xl font-black text-white mt-6 tracking-tighter">Welcome Back</h2>
                    <p class="text-slate-500 text-sm mt-1">Enter your credentials to continue.</p>
                </div>

                <form @submit.prevent="handleLogin" class="space-y-6 text-left">
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Username</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-5 h-5"></i>
                            <input v-model="loginUsername" type="text" required placeholder="yourusername" class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-4 pl-12 pr-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Password</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-5 h-5"></i>
                            <input v-model="loginPassword" :type="showPassword ? 'text' : 'password'" required placeholder="••••••••" class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-4 pl-12 pr-12 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            <button type="button" @click="showPassword = !showPassword" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition-colors">
                                <i :data-lucide="showPassword ? 'eye-off' : 'eye'" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all">Sign In</button>
                </form>
                
                <p class="text-center mt-8 text-slate-500 text-sm">
                    New to Kaizen? <button @click="authState = 'register'" class="text-indigo-400 font-bold hover:underline">Create an account</button>
                </p>
                <button @click="authState = 'landing'" class="w-full mt-4 text-slate-600 text-xs font-bold uppercase tracking-widest hover:text-slate-400 transition-colors">Back to Landing</button>
            </div>
        </div>

        <!-- Register Page -->
        <div v-if="authState === 'register'" class="min-h-screen flex items-center justify-center p-6 animate-in">
            <div class="w-full max-w-md glass p-10 rounded-[2.5rem] shadow-2xl">
                <div class="flex flex-col items-center mb-8">
                    <kaizen-logo size="32"></kaizen-logo>
                    <h2 class="text-3xl font-black text-white mt-6 tracking-tighter">Join Kaizen</h2>
                    <p class="text-slate-500 text-sm mt-1">Start your journey to debt freedom.</p>
                </div>

                <form @submit.prevent="handleRegister" class="space-y-4 text-left">
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest block mb-1.5 ml-1">Full Name</label>
                        <div class="relative">
                            <i data-lucide="user-circle" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-5 h-5"></i>
                            <input v-model="regName" type="text" required placeholder="Alex Kaizen" class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-3.5 pl-12 pr-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest block mb-1.5 ml-1">Email</label>
                        <div class="relative">
                            <i data-lucide="mail" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-5 h-5"></i>
                            <input v-model="regEmail" type="email" required placeholder="alex@kaizen.com" class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-3.5 pl-12 pr-4 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest block mb-1.5 ml-1">Password</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-5 h-5"></i>
                            <input v-model="regPassword" :type="showRegPassword ? 'text' : 'password'" required placeholder="••••••••" class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-3.5 pl-12 pr-12 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            <button type="button" @click="showRegPassword = !showRegPassword" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition-colors">
                                <i :data-lucide="showRegPassword ? 'eye-off' : 'eye'" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-black text-slate-500 uppercase tracking-widest block mb-1.5 ml-1">Confirm Password</label>
                        <div class="relative">
                            <i data-lucide="shield-check" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 w-5 h-5"></i>
                            <input v-model="regConfirmPassword" :type="showRegConfirmPassword ? 'text' : 'password'" required placeholder="••••••••" class="w-full bg-slate-900 border border-slate-700 rounded-2xl py-3.5 pl-12 pr-12 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            <button type="button" @click="showRegConfirmPassword = !showRegConfirmPassword" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-white transition-colors">
                                <i :data-lucide="showRegConfirmPassword ? 'eye-off' : 'eye'" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4.5 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-all mt-4">Create Account</button>
                </form>
                
                <p class="text-center mt-6 text-slate-500 text-sm">
                    Already have an account? <button @click="authState = 'login'" class="text-indigo-400 font-bold hover:underline">Login here</button>
                </p>
                <button @click="authState = 'landing'" class="w-full mt-4 text-slate-600 text-xs font-bold uppercase tracking-widest hover:text-slate-400 transition-colors">Back to Landing</button>
            </div>
        </div>

        <!-- Main Dashboard Layout -->
        <div v-if="authState === 'dashboard'" class="min-h-screen flex flex-col lg:flex-row">
            
            <!-- Mobile Navigation -->
            <div class="lg:hidden bg-slate-900/80 backdrop-blur-md border-b border-slate-800 px-6 py-4 flex items-center justify-between sticky top-0 z-50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-600 rounded-xl flex items-center justify-center text-white"><i data-lucide="arrow-up-right" class="w-5 h-5"></i></div>
                    <span class="text-lg font-black tracking-tighter">Kaizen Finance</span>
                </div>
                <button @click="isMobileMenuOpen = !isMobileMenuOpen" class="p-2 text-slate-400 bg-slate-800 rounded-lg">
                    <i :data-lucide="isMobileMenuOpen ? 'x' : 'menu'"></i>
                </button>
            </div>

            <!-- Sidebar -->
            <aside :class="isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'" class="fixed inset-y-0 left-0 w-72 bg-slate-900/50 backdrop-blur-xl border-r border-slate-800 flex flex-col z-[60] transition-transform duration-300 lg:translate-x-0 lg:static h-screen">
                <div class="p-8 pb-4 flex items-center gap-3 shrink-0">
                    <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white rotate-3 shadow-lg"><i data-lucide="arrow-up-right" class="w-6 h-6"></i></div>
                    <div class="text-left text-white">
                        <span class="text-xl font-black tracking-tighter block leading-tight">Kaizen Finance</span>
                        <span class="text-[10px] text-indigo-400 font-black uppercase tracking-widest block">Continuous Growth</span>
                    </div>
                </div>

                <!-- Scrollable Menu -->
                <div class="flex-1 overflow-y-auto px-8 py-4 custom-scrollbar">
                    <nav class="flex flex-col gap-2">
                        <p class="px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3 text-left">Main</p>
                        <button v-for="item in navItems" :key="item.id" @click="navigateTo(item.id)" :class="currentPage === item.id ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200">
                            <i :data-lucide="item.icon" class="w-5 h-5"></i>
                            <span class="font-semibold text-sm">{{ item.label }}</span>
                        </button>
                        
                        <div class="h-px bg-slate-800 my-4"></div>
                        <p class="px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3 text-left">Categories</p>
                        <button v-for="cat in categories" :key="cat.id" @click="navigateTo(cat.id)" :class="currentPage === cat.id ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200">
                            <i :data-lucide="cat.icon" class="w-5 h-5"></i>
                            <span class="font-semibold text-sm">{{ cat.label }}</span>
                        </button>
                    </nav>
                </div>

                <!-- Bottom Stats & Profile -->
                <div class="p-6 space-y-4 bg-slate-900/30 border-t border-slate-800/50">
                    <div class="bg-slate-900/50 p-5 rounded-[1.5rem] border border-slate-800">
                        <div class="flex justify-between mb-3 text-white">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Overall Goal</span>
                            <span class="text-indigo-400 font-black text-xs">{{ progressPercent }}%</span>
                        </div>
                        <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden p-0.5">
                            <div class="h-full bg-gradient-to-r from-indigo-600 to-emerald-500 rounded-full transition-all duration-1000" :style="{ width: progressPercent + '%' }"></div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-4 glass rounded-[1.5rem] shadow-xl">
                        <div class="flex items-center gap-4 flex-1 min-w-0">
                            <div class="w-10 h-10 shrink-0 rounded-full bg-indigo-600 flex items-center justify-center font-black text-white">{{ userInitial }}</div>
                            <div class="text-left min-w-0">
                                <p class="text-sm font-black text-white truncate w-full capitalize leading-tight mb-1">{{ userName }}</p>
                                <div class="flex items-center gap-1 text-[9px] text-emerald-500 font-black uppercase"><i data-lucide="shield-check" class="w-3 h-3"></i> Destroyer</div>
                            </div>
                        </div>
                        <button @click="handleLogout" class="p-2 text-slate-500 hover:text-rose-400 transition-all"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 p-6 md:p-12 lg:p-16 max-w-[1400px] w-full mx-auto h-screen overflow-y-auto custom-scrollbar animate-in">
                
                <!-- Dashboard View -->
                <div v-if="currentPage === 'dashboard'" class="space-y-8">
                    <!-- Journey Track -->
                    <div class="glass p-8 md:p-12 rounded-[2.5rem] relative overflow-hidden">
                        <div class="flex items-center justify-between mb-12">
                            <div class="text-left text-white">
                                <h2 class="text-2xl font-black tracking-tight flex items-center gap-3"><i data-lucide="trophy" class="text-amber-500"></i> Journey to Freedom</h2>
                                <p class="text-slate-400 text-sm font-medium mt-1">Continuous improvement: One payment at a time.</p>
                            </div>
                            <div class="text-right">
                                <span class="text-5xl font-black text-indigo-500 tracking-tighter">{{ progressPercent }}%</span>
                                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-1">Total Completion</p>
                            </div>
                        </div>
                        <div class="relative pt-10 pb-16 px-4">
                            <div class="h-4 w-full bg-slate-900 rounded-full border border-slate-700 overflow-hidden p-1">
                                <div class="h-full bg-gradient-to-r from-indigo-600 via-indigo-400 to-emerald-400 rounded-full transition-all duration-1000 shadow-sm" :style="{ width: progressPercent + '%' }"></div>
                            </div>
                            <div class="absolute inset-x-4 top-10 h-full pointer-events-none text-center flex justify-between">
                                <div v-for="marker in markers" :key="marker.p" :style="{ left: marker.p + '%' }" class="absolute top-0 flex flex-col items-center -translate-x-1/2">
                                    <div :class="[progressPercent >= marker.p ? (marker.target ? 'bg-emerald-500' : 'bg-indigo-500') : 'bg-slate-700']" class="w-1 h-6 transition-colors duration-500"></div>
                                    <div class="mt-2 text-white">
                                        <p :class="[progressPercent >= marker.p ? (marker.target ? 'text-emerald-400' : 'text-indigo-400') : 'text-slate-600']" class="text-[10px] font-black tracking-tighter">{{ marker.p }}%</p>
                                        <p :class="[progressPercent >= marker.p ? 'text-slate-300' : 'text-slate-600']" class="text-[8px] font-bold uppercase tracking-widest hidden md:block whitespace-nowrap">{{ marker.l }}</p>
                                    </div>
                                    <div v-if="marker.target" :class="[progressPercent >= marker.p ? 'text-emerald-500' : 'text-slate-600']" class="absolute -top-8"><i data-lucide="flag" class="w-4 h-4"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 flex items-center gap-2 text-xs font-bold text-slate-400 bg-slate-900/50 w-fit px-4 py-2 rounded-full border border-slate-700">
                            <i data-lucide="check-circle-2" class="text-emerald-500 w-4 h-4"></i> Total Kaizen: <span class="text-slate-200 ml-1">£{{ totalPaid.toLocaleString() }} paid</span>
                        </div>
                    </div>

                    <!-- Core Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div v-for="stat in mainStats" :key="stat.title" class="glass p-6 rounded-[2rem] text-left">
                            <div :class="stat.color" class="p-3 rounded-2xl text-white w-fit mb-4 shadow-inner"><i :data-lucide="stat.icon"></i></div>
                            <h3 class="text-slate-400 text-xs font-bold uppercase tracking-widest text-left">{{ stat.title }}</h3>
                            <div class="flex items-baseline gap-1 mt-1 text-white"><span class="text-3xl font-black">£{{ stat.value.toLocaleString() }}</span></div>
                            <p class="text-[10px] text-slate-500 mt-2 font-medium flex items-center gap-1"><i data-lucide="shield-check" class="text-emerald-500 w-3 h-3"></i> {{ stat.sub }}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 text-left">
                        <div class="glass p-8 rounded-[2.5rem] text-left">
                            <h2 class="text-xl font-black text-white mb-8 flex items-center gap-2"><i data-lucide="filter" class="text-indigo-400"></i> Category Progress</h2>
                            <div class="space-y-4">
                                <div v-for="(stat, key) in categoryProgress" :key="key" @click="navigateTo(stat.id)" class="group flex items-center justify-between p-5 rounded-2xl hover:bg-slate-700/50 cursor-pointer border border-transparent hover:border-slate-700 transition-all active:scale-[0.98]">
                                    <div class="flex items-center gap-4">
                                        <div :class="stat.colorClass" class="p-3 rounded-xl text-white"><i :data-lucide="stat.icon"></i></div>
                                        <div>
                                            <p class="font-black text-slate-200 text-sm">{{ key }}s</p>
                                            <p class="text-[10px] text-slate-500 uppercase font-bold tracking-tight">£{{ stat.paid.toLocaleString() }} paid</p>
                                        </div>
                                    </div>
                                    <div class="text-right flex items-center gap-6">
                                        <div>
                                            <p class="font-black text-white">£{{ stat.balance.toLocaleString() }}</p>
                                            <div class="flex items-center gap-2 mt-1.5">
                                                <div class="w-20 h-1.5 bg-slate-900 rounded-full overflow-hidden">
                                                    <div :class="stat.colorClass" class="h-full transition-all duration-1000" :style="{ width: stat.pct + '%' }"></div>
                                                </div>
                                                <span class="text-[10px] font-black text-indigo-400">{{ Math.round(stat.pct) }}%</span>
                                            </div>
                                        </div>
                                        <i data-lucide="chevron-right" class="text-slate-600"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-indigo-950/50 text-white p-10 rounded-[2.5rem] border border-indigo-500/20 shadow-2xl relative overflow-hidden flex flex-col justify-between">
                            <div class="relative z-10 text-left">
                                <h3 class="text-3xl font-black mb-2 tracking-tight italic">Momentum Engine</h3>
                                <p class="text-indigo-300 text-sm mb-10 leading-relaxed">Boost your monthly payments to crush debt through Kaizen.</p>
                                <div class="space-y-10">
                                    <div>
                                        <div class="flex justify-between items-end mb-4 text-left">
                                            <span class="text-indigo-400 font-bold text-xs uppercase tracking-widest">Monthly Surplus</span>
                                            <div class="text-right"><span class="text-4xl font-black text-white">£{{ extraPayment }}</span></div>
                                        </div>
                                        <input type="range" min="0" max="5000" step="50" v-model.number="extraPayment" class="w-full h-3 bg-indigo-900 rounded-lg appearance-none cursor-pointer accent-white border border-indigo-800">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <button @click="strategy = 'snowball'" :class="strategy === 'snowball' ? 'bg-indigo-500 text-white border-indigo-400' : 'bg-transparent text-indigo-400 border-indigo-800'" class="py-3 px-4 rounded-2xl font-black text-xs uppercase tracking-widest border transition-all">Snowball</button>
                                        <button @click="strategy = 'avalanche'" :class="strategy === 'avalanche' ? 'bg-indigo-500 text-white border-indigo-400' : 'bg-transparent text-indigo-400 border-indigo-800'" class="py-3 px-4 rounded-2xl font-black text-xs uppercase tracking-widest border transition-all">Avalanche</button>
                                    </div>
                                </div>
                            </div>
                            <div class="absolute -bottom-20 -right-20 text-indigo-500/5 rotate-12 pointer-events-none"><i data-lucide="arrow-up-right" class="w-[400px] h-[400px]"></i></div>
                        </div>
                    </div>
                </div>

                <!-- Info Academy View -->
                <div v-if="currentPage === 'info'" class="space-y-12 animate-in text-left">
                    <h2 class="text-4xl font-black text-white tracking-tight flex items-center gap-3"><i data-lucide="lightbulb" class="text-amber-400"></i> Kaizen Academy</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="glass p-10 rounded-[2.5rem]">
                            <div class="bg-indigo-500/10 p-4 w-fit rounded-2xl mb-6 text-indigo-400"><i data-lucide="zap"></i></div>
                            <h3 class="text-2xl font-black text-white mb-4 tracking-tight">The Kaizen Philosophy</h3>
                            <p class="text-slate-400 leading-relaxed">Kaizen means <span class="text-white font-bold">"change for the better."</span> It prioritizes consistent, incremental improvements. A £5 payment today is better than £0 tomorrow.</p>
                        </div>
                        <div class="glass p-10 rounded-[2.5rem]">
                            <div class="bg-emerald-500/10 p-4 w-fit rounded-2xl mb-6 text-emerald-400"><i data-lucide="shield-check"></i></div>
                            <h3 class="text-2xl font-black text-white mb-4 tracking-tight">Debt is Math</h3>
                            <p class="text-slate-400 leading-relaxed">Debt is simply a variable. You are not "bad with money"; you are solving a puzzle. Once the variables align, the debt disappears.</p>
                        </div>
                    </div>
                </div>

                <!-- Category Items View -->
                <div v-if="isCategoryPage" class="animate-in space-y-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
                        <div class="flex items-center gap-5">
                            <div :class="activeCategoryColor" class="p-4 rounded-[1.5rem] text-white shadow-lg"><i :data-lucide="activeCategoryIcon" class="w-8 h-8"></i></div>
                            <div class="text-left">
                                <h2 class="text-3xl font-black text-white tracking-tight">{{ activeCategoryTitle }}</h2>
                                <p class="text-slate-500 text-sm font-medium">Current Owed: <span class="text-white font-bold">£{{ activeCategoryTotal.toLocaleString() }}</span></p>
                            </div>
                        </div>
                        <button @click="handleAddDebt(activeCategoryKey)" class="bg-indigo-600 text-white px-6 py-3.5 rounded-2xl font-black text-sm flex items-center justify-center gap-2 hover:bg-indigo-700 transition-all shadow-lg active:scale-95">
                            <i data-lucide="plus"></i> Add Entry
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div v-if="filteredDebts.length === 0" class="glass border-2 border-dashed border-slate-700/50 py-20 rounded-[2.5rem] text-center flex flex-col items-center gap-4">
                            <i data-lucide="target" class="w-10 h-10 text-slate-600"></i>
                            <p class="text-slate-600 font-bold uppercase tracking-widest text-xs">Category Clear</p>
                        </div>
                        <div v-for="debt in filteredDebts" :key="debt.id" class="bg-slate-800/80 p-6 md:p-8 rounded-[2rem] border border-slate-700/50 shadow-sm flex flex-col md:flex-row items-center justify-between gap-8 hover:shadow-xl transition-all border-l-4" :style="{ borderLeftColor: 'currentColor' }">
                            <div class="flex-1 w-full text-left">
                                <div class="flex items-center gap-2 mb-3">
                                    <input v-model="debt.name" @change="handleUpdateDebt(debt.id, 'name', debt.name)" class="text-xl font-black bg-slate-900/50 focus:bg-slate-900 border-b-2 border-transparent focus:border-indigo-500 transition-all p-2 w-full rounded-t-lg outline-none text-white" placeholder="Enter name...">
                                    <button @click="activePaymentDebt = debt" class="p-2.5 bg-slate-700/50 text-slate-400 hover:text-indigo-400 hover:bg-slate-700 rounded-xl transition-all flex items-center gap-2 font-bold text-xs shrink-0">
                                        <i data-lucide="history" class="w-4 h-4"></i> <span>Payments</span>
                                    </button>
                                </div>
                                <div class="flex flex-wrap items-center gap-4">
                                    <div class="flex items-center gap-2 text-xs font-black text-slate-500 bg-slate-900/50 px-3 py-2 rounded-xl border border-slate-700">
                                        <i data-lucide="pie-chart" class="text-indigo-400 w-4 h-4"></i> 
                                        <span class="mr-1">APR:</span>
                                        <input type="number" v-model.number="debt.interest" @change="handleUpdateDebt(debt.id, 'interest', debt.interest)" class="w-10 bg-transparent border-none outline-none text-slate-300 font-black">%
                                    </div>
                                    <div class="flex items-center gap-2 text-xs font-black text-slate-500 bg-slate-900/50 px-3 py-2 rounded-xl border border-slate-700">
                                        <i data-lucide="calendar" class="text-amber-500 w-4 h-4"></i> 
                                        <span class="mr-1">MIN:</span>
                                        £<input type="number" v-model.number="debt.minPayment" @change="handleUpdateDebt(debt.id, 'minPayment', debt.minPayment)" class="w-16 bg-transparent border-none outline-none text-slate-300 font-black">
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-8 w-full md:w-auto border-t md:border-t-0 border-slate-700 pt-6 md:pt-0">
                                <div class="text-right flex-1 md:flex-none">
                                    <p class="text-[10px] font-black text-slate-600 uppercase tracking-widest mb-1">Current Owed</p>
                                    <div class="flex items-center justify-end gap-1 bg-slate-900/50 px-4 py-2 rounded-2xl border border-slate-700 focus-within:border-indigo-500/50 transition-all">
                                        <span class="text-2xl font-black text-slate-600">£</span>
                                        <input type="number" v-model.number="debt.balance" @change="handleUpdateDebt(debt.id, 'balance', debt.balance)" class="text-3xl font-black text-white bg-transparent border-none outline-none w-32 text-right">
                                    </div>
                                </div>
                                <button @click="handleDeleteDebt(debt.id)" class="p-4 text-slate-600 hover:text-rose-500 hover:bg-rose-500/10 rounded-2xl transition-all">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Payment History Modal -->
        <div v-if="activePaymentDebt" class="fixed inset-0 z-[100] flex items-center justify-end bg-slate-950/80 backdrop-blur-md animate-in">
            <div class="w-full max-w-md h-full bg-slate-900 border-l border-slate-800 shadow-2xl p-8 flex flex-col transition-transform duration-500">
                <div class="flex justify-between items-center mb-8 text-left">
                    <div class="text-left text-white">
                        <h3 class="text-2xl font-black">Payment Log</h3>
                        <p class="text-slate-500 text-sm font-medium">{{ activePaymentDebt.name }}</p>
                    </div>
                    <button @click="activePaymentDebt = null" class="p-2 hover:bg-slate-800 rounded-full transition-colors text-slate-400"><i data-lucide="x"></i></button>
                </div>

                <form @submit.prevent="handleAddPayment" class="bg-slate-800/50 p-6 rounded-[2rem] border border-slate-700/50 mb-8 text-left">
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Record New Payment</label>
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 bg-slate-900 p-4 rounded-2xl border border-slate-700 focus-within:ring-2 focus-within:ring-indigo-500 transition-all">
                            <span class="text-2xl font-black text-slate-600">£</span>
                            <input v-model.number="paymentAmount" type="number" step="0.01" required placeholder="0.00" class="w-full text-2xl font-black focus:outline-none bg-transparent text-white">
                        </div>
                        <div class="flex items-center gap-3 bg-slate-900 p-4 rounded-2xl border border-slate-700">
                            <i data-lucide="calendar" class="text-slate-500"></i>
                            <input v-model="paymentDate" type="date" required class="w-full font-bold text-slate-300 focus:outline-none bg-transparent [color-scheme:dark]">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-sm flex items-center justify-center gap-2 hover:bg-indigo-700 shadow-lg active:scale-95 transition-all">
                            <i data-lucide="check-circle-2" class="w-5 h-5"></i> Confirm Payment
                        </button>
                    </div>
                </form>

                <div class="flex-1 overflow-y-auto custom-scrollbar">
                    <label class="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 text-left">Transaction History</label>
                    <div class="space-y-3 pb-8 text-left">
                        <div v-for="pay in sortedPayments" :key="pay.id" class="flex items-center justify-between p-4 bg-slate-800/50 border border-slate-700/50 rounded-2xl">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-emerald-500/10 text-emerald-500 rounded-lg"><i data-lucide="receipt" class="w-4 h-4"></i></div>
                                <div class="text-left">
                                    <p class="font-black text-slate-200 text-sm">£{{ pay.amount.toLocaleString() }}</p>
                                    <p class="text-[10px] text-slate-500 font-bold">{{ pay.date }}</p>
                                </div>
                            </div>
                            <span class="text-[10px] font-black text-emerald-400 uppercase bg-emerald-500/10 px-2 py-1 rounded">Paid</span>
                        </div>
                        <div v-if="!activePaymentDebt.payments || activePaymentDebt.payments.length === 0" class="text-center py-10 opacity-30 flex flex-col items-center">
                            <i data-lucide="history" class="w-10 h-10 mb-2 text-slate-400"></i>
                            <p class="text-slate-400 text-xs font-bold uppercase tracking-widest">No history</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Toast -->
        <div v-if="notification" class="fixed bottom-8 right-8 z-[110] bg-indigo-600 text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 animate-in">
            <i data-lucide="check-circle-2" class="text-indigo-200"></i>
            <span class="font-bold text-sm">{{ notification }}</span>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, setDoc, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Add error boundary for Telegram Mini Apps
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('deployment-error').style.display = 'block';
            document.getElementById('error-message').innerText = msg + ' at ' + url + ':' + line;
        };

        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Firebase config missing or invalid");
            firebaseConfig = {}; // Fallback to avoid crash
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kaizen-finance-v1';

        const { createApp, ref, computed, onMounted, watch } = Vue;

        const KaizenLogo = {
            props: ['size'],
            template: `
                <div class="relative flex items-center justify-center" :style="{ width: parseInt(size) + 16 + 'px', height: parseInt(size) + 16 + 'px' }">
                    <div class="absolute inset-0 bg-indigo-600 rounded-[1.25rem] rotate-6 opacity-20 animate-pulse"></div>
                    <div class="relative w-full h-full bg-indigo-600 rounded-[1.25rem] flex items-center justify-center text-white shadow-xl shadow-indigo-900/40">
                        <svg :width="size" :height="size" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 20h18"></path>
                            <path d="M16 4l5 5-5 5"></path>
                            <path d="M3 16l8-8 10 10"></path>
                        </svg>
                    </div>
                </div>
            `
        };

        createApp({
            components: { KaizenLogo },
            setup() {
                const authState = ref('landing');
                const user = ref(null);
                const userProfile = ref({ name: 'User' });
                const isLoading = ref(true);
                const currentPage = ref('dashboard');
                const isMobileMenuOpen = ref(false);
                const notification = ref(null);
                const debts = ref([]);
                const extraPayment = ref(200);
                const strategy = ref('snowball');
                
                const loginUsername = ref('');
                const loginPassword = ref('');
                const showPassword = ref(false);

                const regName = ref('');
                const regEmail = ref('');
                const regPassword = ref('');
                const regConfirmPassword = ref('');
                const showRegPassword = ref(false);
                const showRegConfirmPassword = ref(false);

                const activePaymentDebt = ref(null);
                const paymentAmount = ref(null);
                const paymentDate = ref(new Date().toISOString().split('T')[0]);

                const navItems = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                    { id: 'info', label: 'Kaizen Academy', icon: 'info' },
                ];

                const categories = [
                    { id: 'credit-cards', label: 'Credit Cards', icon: 'credit-card', key: 'Credit Card' },
                    { id: 'education', label: 'School Fees', icon: 'book-open', key: 'Education' },
                    { id: 'personal', label: 'Personal Debts', icon: 'user', key: 'Personal' },
                    { id: 'subscriptions', label: 'Subscriptions', icon: 'trash-2', key: 'Subscriptions' },
                ];

                const features = [
                    { title: 'Momentum Engine', desc: 'Visualize exactly how extra payments crush your debt balance.', icon: 'zap', color: 'bg-indigo-500' },
                    { title: 'Milestones', desc: 'Celebrate every 25%, 50%, and the 70% home stretch.', icon: 'trophy', color: 'bg-emerald-500' },
                    { title: 'Strategic Payoffs', desc: 'Built-in Snowball and Avalanche strategy tracking.', icon: 'shield-check', color: 'bg-blue-500' }
                ];

                const markers = [
                    { p: 0, l: 'Start' }, { p: 25, l: 'Quarter' }, { p: 50, l: 'Half' }, { p: 70, l: 'Home Stretch', target: true }, { p: 100, l: 'Freedom' }
                ];

                onMounted(() => {
                    onAuthStateChanged(auth, async (u) => {
                        if (u) {
                            user.value = { uid: u.uid };
                            const profileRef = doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'data');
                            onSnapshot(profileRef, (snap) => {
                                if (snap.exists()) {
                                    userProfile.value = snap.data();
                                }
                            });
                            authState.value = 'dashboard';
                            syncData();
                        } else {
                            if (authState.value === 'dashboard') {
                                authState.value = 'landing';
                            }
                        }
                        isLoading.value = false;
                        setTimeout(() => lucide.createIcons(), 100);
                    });
                });

                const handleLogin = async () => {
                    try {
                        isLoading.value = true;
                        await signInAnonymously(auth);
                        showToast("Welcome back!");
                    } catch (e) {
                        showToast("Login failed");
                    } finally {
                        isLoading.value = false;
                    }
                };

                const handleRegister = async () => {
                    if (regPassword.value !== regConfirmPassword.value) {
                        showToast("Passwords do not match");
                        return;
                    }
                    try {
                        isLoading.value = true;
                        const cred = await signInAnonymously(auth);
                        const profileRef = doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile', 'data');
                        await setDoc(profileRef, {
                            name: regName.value,
                            email: regEmail.value,
                            username: regEmail.value.split('@')[0],
                            createdAt: new Date().toISOString()
                        });
                        showToast("Account created!");
                    } catch (e) {
                        showToast("Registration failed");
                    } finally {
                        isLoading.value = false;
                    }
                };

                const handleLogout = () => {
                    signOut(auth);
                    authState.value = 'landing';
                    debts.value = [];
                    userProfile.value = { name: 'User' };
                };

                const syncData = () => {
                    if (!user.value) return;
                    const debtsRef = collection(db, 'artifacts', appId, 'users', user.value.uid, 'debts');
                    onSnapshot(debtsRef, (snapshot) => {
                        debts.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        setTimeout(() => lucide.createIcons(), 0);
                    }, (err) => showToast("Cloud error"));
                };

                const showToast = (msg) => {
                    notification.value = msg;
                    setTimeout(() => notification.value = null, 3000);
                };

                const navigateTo = (page) => {
                    currentPage.value = page;
                    isMobileMenuOpen.value = false;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    setTimeout(() => lucide.createIcons(), 100);
                };

                const totalBalance = computed(() => debts.value.reduce((s, d) => s + (d.balance || 0), 0));
                const totalPaid = computed(() => debts.value.reduce((s, d) => s + (d.payments?.reduce((ps, p) => ps + p.amount, 0) || 0), 0));
                const totalMinPayment = computed(() => debts.value.reduce((s, d) => s + (d.minPayment || 0), 0));
                const progressPercent = computed(() => {
                    const original = totalBalance.value + totalPaid.value;
                    return original > 0 ? Math.round((totalPaid.value / original) * 100) : 0;
                });

                const mainStats = computed(() => [
                    { title: 'Total debt', value: totalBalance.value, icon: 'trending-down', color: 'bg-rose-500/80', sub: 'Remaining balance' },
                    { title: 'Minimum payments', value: totalMinPayment.value, icon: 'calendar', color: 'bg-amber-500/80', sub: 'Mandatory burn' },
                    { title: 'total payments', value: totalMinPayment.value + extraPayment.value, icon: 'zap', color: 'bg-indigo-500/80', sub: 'Monthly velocity' }
                ]);

                const categoryProgress = computed(() => {
                    const stats = {};
                    categories.forEach(c => {
                        const items = debts.value.filter(d => d.category === c.key);
                        const bal = items.reduce((s, d) => s + (d.balance || 0), 0);
                        const paid = items.reduce((s, d) => s + (d.payments?.reduce((ps, p) => ps + p.amount, 0) || 0), 0);
                        const original = bal + paid;
                        stats[c.key] = {
                            id: c.id, icon: c.icon, balance: bal, paid: paid,
                            pct: original > 0 ? (paid / original) * 100 : 0,
                            colorClass: c.id === 'credit-cards' ? 'bg-blue-600' : c.id === 'education' ? 'bg-emerald-600' : c.id === 'personal' ? 'bg-purple-600' : 'bg-rose-500'
                        };
                    });
                    return stats;
                });

                const isCategoryPage = computed(() => categories.some(c => c.id === currentPage.value));
                const activeCategoryKey = computed(() => categories.find(c => c.id === currentPage.value)?.key);
                const activeCategoryTitle = computed(() => categories.find(c => c.id === currentPage.value)?.label);
                const activeCategoryIcon = computed(() => categories.find(c => c.id === currentPage.value)?.icon);
                const activeCategoryColor = computed(() => categoryProgress.value[activeCategoryKey.value]?.colorClass);
                const activeCategoryTotal = computed(() => categoryProgress.value[activeCategoryKey.value]?.balance || 0);

                const filteredDebts = computed(() => debts.value.filter(d => d.category === activeCategoryKey.value));
                const sortedPayments = computed(() => {
                    if (!activePaymentDebt.value?.payments) return [];
                    return [...activePaymentDebt.value.payments].sort((a, b) => new Date(b.date) - new Date(a.date));
                });

                const handleAddDebt = async (category) => {
                    try {
                        const debtsRef = collection(db, 'artifacts', appId, 'users', user.value.uid, 'debts');
                        await addDoc(debtsRef, {
                            name: `New ${category}`, balance: 0, interest: 0, minPayment: 0,
                            category, payments: [], createdAt: new Date().toISOString()
                        });
                        showToast("Added entry");
                    } catch (e) { showToast("Sync error"); }
                };

                const handleUpdateDebt = async (id, field, val) => {
                    const debtDoc = doc(db, 'artifacts', appId, 'users', user.value.uid, 'debts', id);
                    await updateDoc(debtDoc, { [field]: field === 'name' ? val : (parseFloat(val) || 0) });
                };

                const handleDeleteDebt = async (id) => {
                    const debtDoc = doc(db, 'artifacts', appId, 'users', user.value.uid, 'debts', id);
                    await deleteDoc(debtDoc);
                    showToast("Removed entry");
                };

                const handleAddPayment = async () => {
                    const debt = activePaymentDebt.value;
                    if (!debt || !paymentAmount.value) return;
                    const debtDoc = doc(db, 'artifacts', appId, 'users', user.value.uid, 'debts', debt.id);
                    try {
                        const newPayment = { amount: paymentAmount.value, date: paymentDate.value, id: crypto.randomUUID() };
                        await updateDoc(debtDoc, {
                            balance: Math.max(0, debt.balance - paymentAmount.value),
                            payments: [...(debt.payments || []), newPayment]
                        });
                        activePaymentDebt.value = null;
                        paymentAmount.value = null;
                        showToast("Payment synced");
                    } catch (e) { showToast("Error"); }
                };

                const userName = computed(() => userProfile.value?.name || 'User');
                const userInitial = computed(() => userName.value.charAt(0).toUpperCase());

                watch([authState, currentPage, activePaymentDebt], () => {
                    setTimeout(() => lucide.createIcons(), 100);
                });

                return {
                    authState, user, isLoading, currentPage, isMobileMenuOpen, notification, debts, extraPayment, strategy,
                    loginUsername, loginPassword, showPassword,
                    regName, regEmail, regPassword, regConfirmPassword, showRegPassword, showRegConfirmPassword,
                    navItems, categories, features, markers, navigateTo, totalBalance, totalPaid, totalMinPayment,
                    progressPercent, mainStats, categoryProgress, isCategoryPage, activeCategoryTitle, activeCategoryIcon,
                    activeCategoryColor, activeCategoryTotal, filteredDebts, handleAddDebt, handleUpdateDebt, handleDeleteDebt,
                    activePaymentDebt, paymentAmount, paymentDate, handleAddPayment, sortedPayments, activeCategoryKey,
                    userName, userInitial, handleLogin, handleRegister, handleLogout
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
